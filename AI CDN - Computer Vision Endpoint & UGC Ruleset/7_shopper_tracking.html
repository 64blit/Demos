<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Test Video Upload (URL)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="overflow-auto">
    <div class="container">
        <!-- HEADER: Full width, Logo Image -->
        <header class="mt-4">
            <div class="container-fluid d-flex align-items-center justify-content-between">
                <a href="1_upload_image.html"><img src="css/images/eyepop-logo.svg" alt="EyePop.ai Logo" class="p-2"
                        style="height: 70px;"></a>
                <h1 class="p-2">CDN Workshop Step 7 - Shopper Tracking</h1>
            </div>
        </header>

        <!-- FORM UPLOAD ELEMENT: Centered, Full Width Row -->
        <div class="container-fluid mt-4">
            <div class="row justify-content-center">
                <div id="drop-area" class="col-12">
                    <input id="inputLoadFile" class=" form-control" type="file"></input>

                    <form>
                        <div class="input-group mt-3">
                            <input type="text" class="form-control" placeholder="MP4 url or file path"
                                aria-label="MP4 URL" aria-describedby="basic-addon2" id="txtUrl">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="btnPost">Start</button>
                            </div>
                        </div>
                    </form>

                </div>
            </div>

            <!-- IMAGE PREVIEW AND TEXT AREA: Half and Half -->
            <div class="container-fluid mt-4">
                <div class="row">
                    <div class="col-md-6 d-flex">
                        <h3 id="title" class="ms-auto"></h3>
                    </div>

                    <div class="col-md-6 d-flex">
                        EyePop.ai Results: <h3 id="timing" class="ms-auto">0%</h3>
                        <a class="btn btn-outline-secondary" type="link" id="btnSave">Save</a>

                    </div>

                </div>

                <video id="myLocalVideo" playsinline controls muted style="width:1px;height:1px;"></video>

                <div class="d-flex w-100 justify-content-center">
                    <canvas id="rendercanvas" class="bg-transparent w-100 object-fit-contain z-3 opacity-100"
                        style="height: 40rem; "></canvas>
                </div>

                <div class="d-flex w-100 justify-content-center">
                    <canvas id="mobilecanvas" class="bg-transparent w-100 object-fit-contain z-3 opacity-100"
                        style="height: 40rem; "></canvas>
                </div>
            </div>
        </div>

        <!-- <script src="https://cdn.jsdelivr.net/npm/@eyepop.ai/javascript-sdk"></script> -->
        <script src="./js/EyePopSDK.js"></script>
        <script src="config.js"></script>

        <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three/build/three.module.js",
                "three/addons/": "https://unpkg.com/three/examples/jsm/"
            }
        }
    </script>

        <script type="module">
            import ThirdEyePop from "./js/src/ThirdEyePop.js";

            var cached_data = [];
            const video = document.getElementById("myLocalVideo");
            const urlInput = document.getElementById("txtUrl");
            const analyzedPercentText = document.getElementById("timing");
            const canvas = document.getElementById("mobilecanvas");
            const renderCanvas = document.getElementById("rendercanvas");
            const inputFile = document.getElementById("inputLoadFile");

            // urlInput.value = "https://raw.githubusercontent.com/64blit/files/main/videos/store_cctv.mp4";

            const load = () =>
            {
                var fileToLoad = inputFile.files[ 0 ];
                var fileReader = new FileReader();

                fileReader.onload = function (fileLoadedEvent)
                {
                    var textFromFileLoaded = fileLoadedEvent.target.result;
                    var data = JSON.parse(textFromFileLoaded);
                    cached_data = data.body;
                    urlInput.value = data.url;
                    const jsonData = JSON.parse(fileReader.result);
                    urlInput.value = jsonData.url;
                    run();
                };
                fileReader.readAsText(fileToLoad, "UTF-8");
            }

            function save()
            {
                var dataStr = JSON.stringify({ url: urlInput.value, body: cached_data });
                var blob = new Blob([ dataStr ], { type: "text/json;charset=utf-8" });
                var url = URL.createObjectURL(blob);

                var btnSave = document.getElementById('btnSave');
                btnSave.onclick = function ()
                {
                    var dlAnchorElem = document.createElement('a');
                    dlAnchorElem.href = url;
                    dlAnchorElem.download = urlInput.value + ".json";
                    dlAnchorElem.click();

                    setTimeout(function ()
                    {
                        document.body.removeChild(dlAnchorElem);
                        window.URL.revokeObjectURL(url);
                    }, 1000);
                };
            }

            const run = () =>
            {
                var url = urlInput.value;
                if (!url) return;
                let percentBuffered = 0;

                const thirdEyePop = new ThirdEyePop({ canvas: renderCanvas, videoUrl: urlInput.value, frameData: cached_data, DEBUG: true });

                thirdEyePop.setup();

                if (cached_data.length > 0)
                {
                    thirdEyePop.render();
                    return;
                }

                // NOTE: This is a confusing thing to do, why pass a name parameter and not just the url
                config.Input = {
                    "name": "url",
                    "url": url
                };

                // NOTE: This is confusing also, enabling drawing should be done through a boolean not by setting an array
                config.Draw = [
                    { "Type": "pose", "Targets": [ "person" ] },
                    { "Type": "box", "Targets": [ "person" ] },
                ];

                // NOTE: EyePopSDK.EyePopSDK is a confusing name, why not just EyePopSDK
                const ep = EyePopSDK.EyePopSDK.init(config);

                EyePopSDK.EyePopAPI.instance.OnPrediction = function (data)
                {
                    // console.log(data);
                    data.timestamp = data.timestamp / 1000000000;

                    percentBuffered = data.seconds / video.duration;
                    analyzedPercentText.innerHTML = Math.floor(percentBuffered * 100) + "%";

                    cached_data.push(data);
                };

                EyePopSDK.EyePopAPI.instance.OnPredictionEnd = function (data)
                {
                    analyzedPercentText.innerHTML = "100% analyzed."

                    save();
                }

                EyePopSDK.EyePopAPI.instance.OnDrawFrame = function ()
                {
                    var closestIndex = findClosestIndex(cached_data, video.currentTime);
                    if (!closestIndex || closestIndex == -1)
                        return

                    var el = cached_data[ closestIndex ];

                    //console.log(video.currentTime, el, cached_data.length);
                    EyePopSDK.EyePopAPI.instance.lastmsg = el;
                }

                EyePopSDK.EyePopAPI.instance.OnDrawFrameEnd = function (data)
                {
                    if (!thirdEyePop) return;

                    thirdEyePop.render();
                }

            }

            document.getElementById("btnPost").addEventListener("click", run);
            inputFile.addEventListener("change", load);

            EyePopSDK.EyePopAPI.FetchPopConfig(pop_endpoint, token)
                .then(response => config = response)
                .then(() => { document.getElementById("title").innerHTML = config.name; });


            function findClosestIndex(bufferedTimes, currentTime)
            {
                let closestIndex = -1;
                let closestDiff = Infinity;

                for (let i = 0; i < bufferedTimes.length; i++)
                {

                    const diff = Math.abs(currentTime - bufferedTimes[ i ].timestamp);

                    //diff <= (1/24) && 
                    if (diff < closestDiff)
                    {
                        closestDiff = diff;
                        closestIndex = i;
                    }
                }

                return closestIndex;
            }

        </script>
</body>

</html>
