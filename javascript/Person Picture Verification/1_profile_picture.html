<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <title>3 Visualize EyePop.ai Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@eyepop.ai/javascript-sdk"></script>

</head>

<body>
    <!-- A spinning loading animation -->
    <div id="loading"
        class="position-absolute top-0 w-100 h-100 d-flex align-items-center justify-content-center bg-black flex-column"
        style="z-index: 1000;">
        <div id="loadingText" class="text-white text-start p-5">Loading Pop...</div>
        <div class="spinner-border text-light align-self-center" role="status">

            <span class="visually-hidden">Loading...</span>

        </div>
    </div>

    <div class="container" style="max-width: 1200px;">
        <!-- HEADER: Full width, Logo Image -->
        <header class="mt-4">
            <div class="container-fluid d-flex align-items-center">

                <a href="1_upload_image.html"><img src="css/images/eyepop-logo.svg" alt="EyePop.ai Logo" class="p-2"
                        style="height: 70px;"></a>
            </div>

            <video id="myLocalVideo" playsinline controls muted class="position-absolute"
                style="width:1px;height:1px;"></video>

        </header>

        <div class="w-100 h-100 d-flex justify-content-center">

            <!-- Upload profile -->
            <div class="col-xxl-4 bg-light rounded outline border-2 border-light">
                <div class="bg-secondary-soft px-4 py-5 rounded">
                    <div class="d-flex flex-column align-items-center">
                        <h4 class="mb-4 mt-0">Upload your profile photo</h4>
                        <h6 class="mb-4 text-danger"> * Image must contain single person</h6>

                        <!-- Image upload -->
                        <div class="rounded-circle position-relative  overflow-hidden  mb-3 bg-dark-subtle "
                            style="height: 20rem; width: 20rem;">
                            <i id="profileIcon"
                                class="fas fa-fw fa-user position-absolute top-50 start-50 translate-middle text-secondary"></i>

                            <div
                                class="w-100 h-100 d-flex justify-content-center align-items-center object-fit-cover overflow-hidden">
                                <canvas id="mobilecanvas" class="min-w-100 w-100 h-100 min-h-100"
                                    src="css/images/empty.png" alt="Image Preview" style="object-fit: cover;"></canvas>
                            </div>
                        </div>

                        <!-- Content -->
                        <p class="text-muted mt-3 mb-0"><span class="me-1">Note:</span>Minimum size 300px x 300px</p>

                        <form>
                            <input type="file" id="file_upload" name="file" hidden="">
                        </form>

                        <div class="d-flex gap-1">
                            <label id="uploadButton" class="btn btn-success btn-block" for="file_upload">Upload</label>
                            <button id="removeButton" type="button" class="btn btn-danger">Remove</button>
                        </div>



                        <h4 class=" m-4 font-bold visually-hidden" style="max-width: 20rem;" for="file_upload">
                            <span id="feedbackMessage" class="text-danger"></span>
                        </h4>


                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="../config.js"></script>

    <script>
        const loading = document.getElementById('loading');
        const mobilecanvas = document.getElementById('mobilecanvas');
        const file_upload = document.getElementById('file_upload');
        const uploadButton = document.getElementById('uploadButton');
        const removeButton = document.getElementById('removeButton');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const profileIcon = document.getElementById('profileIcon');

        async function run()
        {


            async function processFile(file)
            {

                config = await EyePopSDK.EyePopAPI.FetchPopConfig(pop_endpoint, token);

                console.log("EyePopSDK config: ", config);

                config.input = {
                    "name": "file_upload",
                };

                config.draw = [
                    { "type": "box", "targets": [ "*" ] },
                    { "type": "pose", "targets": [ "*" ] },
                    { "type": "hand", "targets": [ "*" ] },
                    { "type": "face", "targets": [ "*" ] },
                ];

                EyePopSDK.EyePopSDK.init(config);

                EyePopSDK.EyePopAPI.instance.OnPrediction = (prediction) =>
                {
                    console.log("OnPrediction", prediction);

                    let personCount = 0;

                    for (let i = 0; i < prediction.objects.length; i++)
                    {
                        if (prediction.objects[ i ].classLabel == "person")
                        {
                            personCount++;
                        }
                    }

                    feedbackMessage.parentElement.classList.remove('visually-hidden');
                    if (personCount === 1)
                    {
                        feedbackMessage.classList.add('text-success');
                        feedbackMessage.classList.remove('text-danger');
                        feedbackMessage.innerHTML = "Success! Single person detected.";
                    } else
                    {
                        feedbackMessage.classList.add('text-danger');
                        feedbackMessage.classList.remove('text-success');
                        feedbackMessage.innerHTML = "People detected: " + personCount + ". Please upload an image with a single person.";
                    }
                }

                EyePopSDK.EyePopAPI.GetJSONFromEyePop_file(file);

                // draw the image on the canvas
                const ctx = mobilecanvas.getContext('2d');
                const img = new Image();
                img.onload = () =>
                {
                    mobilecanvas.width = img.width;
                    mobilecanvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = URL.createObjectURL(file);

                profileIcon.classList.add('visually-hidden');
            }

            file_upload.addEventListener('change', function (event)
            {
                console.log('Processing Image:', file_upload.files[ 0 ]);

                let file = file_upload.files[ 0 ];

                if (file)
                {
                    processFile(file);
                }
            });

            removeButton.addEventListener('click', function (event)
            {
                profileIcon.classList.remove('visually-hidden');
                mobilecanvas.width = 0;
                mobilecanvas.height = 0;
                file_upload.value = "";
                profileIcon.style.display = "block";
            });

        }


        EyePopSDK.EyePopAPI.FetchPopConfig(pop_endpoint, token)
            .then(() => { loading.remove(); })
            .then(() => { run(); });

    </script>
</body>

</html>
