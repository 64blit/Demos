<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Basic Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="overflow-hidden d-flex align-content-center bg-black" style="width: 100vw; height: 100vh;">

    <!-- A spinning loading animation -->
    <div id="loading" class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center bg-black"
        style="z-index: 1000;">
        <div class="spinner-border text-light align-self-center" role="status">

            <span class="visually-hidden">Loading...</span>

        </div>
    </div>

    <header
        class="d-flex align-self-center justify-content-center align-content-center mt-4 position-absolute w-100 top-0 mx-auto z-3">
        <div class="container-fluid d-flex align-items-center justify-content-between text-center">
            <a href="1_upload_image.html"><img src="css/images/eyepop-logo.svg" alt="EyePop.ai Logo" class="p-2"
                    style="height: 70px;"></a>
            <h1 class="p-2 text-center text-white">Image / Video Tester</h1>
            <h6 id="popConfigName" class="text-center text-white">test</h6>
        </div>
    </header>
    <!-- FORM UPLOAD ELEMENT: Centered, Full Width Row -->
    <div class="container-fluid mt-4 position-absolute mx-auto" style="right: 0; top: 5rem;">
        <div class="row justify-content-center container p-5">
            <div id="drop-area" class="col-12">

                <form>
                    <input type="file" class="form-control" id="file_upload" webkitdirectory>
                </form>

                <form class="col-12">
                    <input type="text" class="form-control" placeholder="MP4 URL" aria-label="MP4 URL"
                        aria-describedby="basic-addon2" id="txtUrl">
                    <button class="btn btn-outline-secondary" type="button" id="btnPost">Post</button>
                </form>
            </div>
        </div>
    </div>
    </div>

    <div class="d-flex align-self-center justify-content-center">


        <!-- The rendering canvas which three.js is writing to object-fit-contain -->
        <div id="canvasParent" class="d-flex w-100 h-100 align-self-center justify-content-end align-content-center">
            <canvas id="rendercanvas" class="w-100 h-100 object-fit-scale z-2"></canvas>
        </div>

        <div class="container position-absolute" style="margin-top: -5rem;">

            <!-- The video placeholder for -->
            <video id="myLocalVideo" autoplay playsinline controls muted style="width:1px;height:1px;"></video>


            <!-- A hidden canvas element only used for sending video frames to the EyePop endpoint -->
            <div class="d-flex w-100 justify-content-center"
                style="width:640px;height:480px;margin:auto auto; position: absolute; left: -9999px;">
                <canvas id="mobilecanvas" class="bg-transparent w-100 z-3 opacity-100"
                    style="background-color: transparent; opacity: 1; margin:auto auto;z-index:1000;" width="100%"
                    height="100%"></canvas>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/@eyepop.ai/javascript-sdk"></script>

        <script type="module">
            const pop_endpoint = 'https://staging-api.eyepop.ai/api/v1/user/pops/513/config';
            const token = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InZUdzF6bi02cjFPcXg0NmNxRl9PMiJ9.eyJlbWFpbCI6ImVkbXVuZGRhb0BnbWFpbC5jb20iLCJodHRwczovL2NsYWltcy5leWVwb3AuYWkvZ3JhbnRzIjpbeyJwZXJtaXNzaW9uIjoiYWNjZXNzOmluZmVyZW5jZS1hcGkiLCJ0YXJnZXQiOiJ1c2VyOmF1dGgwfDY1YWVhYmExNTBkMzk1YTNjODA2OGVlZSJ9XSwiaXNzIjoiaHR0cHM6Ly9kZXYtZXllcG9wLnVzLmF1dGgwLmNvbS8iLCJzdWIiOiJhdXRoMHw2NWFlYWJhMTUwZDM5NWEzYzgwNjhlZWUiLCJhdWQiOlsiaHR0cHM6Ly9kZXYtYXBwLmV5ZXBvcC5haSIsImh0dHBzOi8vZGV2LWV5ZXBvcC51cy5hdXRoMC5jb20vdXNlcmluZm8iXSwiaWF0IjoxNzA2MDU1MDkwLCJleHAiOjE3MDYxNDE0OTAsImF6cCI6IklVdDBwczJtYVdaVWRFbUVPUFJhUEpLdmtRVHM2WVVFIiwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCIsInBlcm1pc3Npb25zIjpbXX0.TMkcM3FWNVrOA7PUdlvJ2oJ-J8Ofq1oPnzkG8VfVQ4JkCUd1P2Jj22UlIChxko13wTdT1UCc22HwqMkd-NsGtlz9Vv35DTJIaMc2fcbOpHjoUdFwoVtfxB6FVSNdL1udx7K4dvigyIVZHKKDBYfQQ6gcTO1gkILlyeN9OmrfZB6ZkRRip86UHe9kwvXLdRtXBymzOoIt7aveGcLO_iWVvo9iuEKF8v0iN3FHjpdrPqSXQbVZTcpYq_AqmF4NQw6cJSxdTuDS0bClyDZKf14Z-hLDeLp68mx51p7jNWAqUM2DSRlFNNmq2KdhqnYDOSVl5NqWUorkMv5JVWTpB1xMSg';
            var config = {};

            var fileInput = document.getElementById('file_upload');
            const postButton = document.getElementById('btnPost');
            const loading = document.getElementById('loading');

            EyePopSDK.EyePopAPI.FetchPopConfig(pop_endpoint, token).then(response => config = response).then(() =>
            {
                loading.remove();
                document.getElementById("popConfigName").innerHTML = config.name;
            });


            const save = (fileName, data) =>
            {
                return new Promise((resolve, reject) =>
                {
                    const a = document.createElement("a");
                    document.body.appendChild(a);
                    a.style = "display: none";

                    const json = JSON.stringify(data);
                    const blob = new Blob([ json ], { type: "octet/stream" });
                    const url = window.URL.createObjectURL(blob);
                    a.href = url;
                    a.download = fileName + ".json";
                    a.addEventListener("click", () =>
                    {
                        setTimeout(() =>
                        {
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                            resolve();
                        }, 100);
                    });
                    a.click();
                });
            };


            async function GetJSONFromEyePop_file(file)
            {
                let formData = new FormData()
                formData.append('file', file)

                let response = await fetch(config.url + '/pipelines/' + config.pipeline_id + '/source?mode=preempt&processing=sync', {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'authorization': 'Bearer ' + token
                    },
                    body: formData
                }).catch(error => console.error('The party\'s over, there was an error:', error));

                let data = await response.json();

                return data;
            }

            fileInput.addEventListener('change', async function (event)
            {
                // if the target is a directory loop over all files and run this one by one
                for (let i = 0; i < event.target.files.length; i++)
                {
                    let file = event.target.files[ i ];

                    console.log("File: ", file.name);

                    const popConfigFetch = EyePopSDK.EyePopAPI.FetchPopConfig(pop_endpoint, token);

                    config.Draw = [
                        { "Type": "box", "Targets": [ "*" ] },
                        { "Type": "pose", "Targets": [ "*" ] },
                        { "Type": "hand", "Targets": [ "*" ] },
                        { "Type": "face", "Targets": [ "*" ] },
                    ]

                    let result = await popConfigFetch.then((response) =>
                    {
                        config = response;

                        config.Input = {
                            "name": "file_upload",
                        };

                        console.log("EyePopSDK config: ", config);

                        EyePopSDK.EyePopSDK.init(config);

                        response = GetJSONFromEyePop_file(file);
                        return response;
                    });

                    let data = await result;

                    await save(file.name, data);

                    console.log(file.name, data);
                }
            });

            postButton.addEventListener('click', function (event)
            {
                let url = document.getElementById("txtUrl").value;

                console.log("Posted URL: ", url);

                const popConfigFetch = EyePopSDK.EyePopAPI.FetchPopConfig(pop_endpoint, token);

                config.Draw = [
                    { "Type": "box", "Targets": [ "*" ] },
                    { "Type": "pose", "Targets": [ "*" ] },
                    { "Type": "hand", "Targets": [ "*" ] },
                    { "Type": "face", "Targets": [ "*" ] },
                ]

                if (!url)
                { return; }

                popConfigFetch.then((response) =>
                {
                    config = response;
                    config.Input = {
                        "name": "url",
                        "url": url
                    };

                    console.log("EyePopSDK config: ", config);

                    EyePopSDK.EyePopSDK.init(config);

                    EyePopSDK.EyePopAPI.instance.OnDrawFrame = function (data)
                    {
                        console.log("EyePopSDK data: ", data);
                    }

                });

            });


        </script>
</body>

</html>
