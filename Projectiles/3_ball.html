<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Motion Capture</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="overflow-auto">
    <div class="container">

        <header class="mt-4">
            <div class="container-fluid d-flex align-items-center justify-content-between">
                <a href="1_upload_image.html"><img src="css/images/eyepop-logo.svg" alt="EyePop.ai Logo" class="p-2"
                        style="height: 70px;"></a>
                <h1 class="p-2">Ball Throw</h1>
            </div>
            <h6 id="popConfigName" class="mx-auto"></h6>
        </header>

        <div class="container d-flex" style="scale: .75; margin-top: -5rem;">

            <!-- The video placeholder for -->
            <video id="myLocalVideo" autoplay playsinline controls muted style="width:1px;height:1px;"></video>

            <!-- The rendering canvas which three.js is writing to object-fit-contain -->
            <div id="canvasParent" class="d-flex w-100">
                <canvas id="rendercanvas" class="w-100 object-fit-contain z-2 bg-black"></canvas>
            </div>

            <!-- A hidden canvas element only used for sending video frames to the EyePop endpoint -->
            <div class="d-flex w-100 justify-content-center"
                style="width:640px;height:480px;margin:auto auto; position: absolute; left: -9999px;">
                <canvas id="mobilecanvas" class="bg-transparent w-100 z-3 opacity-100"
                    style="background-color: transparent; opacity: 1; margin:auto auto;z-index:1000;" width="100%"
                    height="100%"></canvas>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/@eyepop.ai/javascript-sdk"></script>

        <script src="config.js"></script>

        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three/build/three.module.js",
                    "three/addons/": "https://unpkg.com/three/examples/jsm/"
                }
            }
        </script>

        <script type="module">
            import ThirdEyePop from "../utils/ThirdEyePop.js";
            import { updateScene } from "./3_ball.js";

            var cached_data = [];
            const video = document.getElementById("myLocalVideo");
            const canvas = document.getElementById("mobilecanvas");
            const renderCanvas = document.getElementById("rendercanvas");

            const save = () =>
            {
                const a = document.createElement("a");
                document.body.appendChild(a);
                a.style = "display: none";

                const json = JSON.stringify(cached_data);
                const blob = new Blob([ json ], { type: "octet/stream" });
                const url = window.URL.createObjectURL(blob);
                a.href = url;
                a.download = "ball.json";
                a.click();
                window.URL.revokeObjectURL(url);
            }

            const run = () =>
            {

                const thirdEyePop = new ThirdEyePop(
                    {
                        canvas: renderCanvas,
                        // videoUrl: "webcam",
                        predictionData: cached_data,
                        : 1,
                DEBUG: true,
                    drawParams: {
                // bgCanvas: canvas,
                showHeatmap: false,
                    showPoint: false,
                        showPath: false,
                            showBounds: false,
                                showTraceId: false,
                                    showPose: true,
                                        showHands: true,
                                            showFace: true,
                                                showBloom: false,
                                                    bloomParams: {
                    strength: 0.12,
                        radius: 0.1,
                            threshold: 1.0
                }
            }
                    });

            thirdEyePop
                .setup()
                .then(() =>
                {
                    updateScene(thirdEyePop);
                });

            config.Draw = [
                // { "type": "pose", "targets": [ "*" ] },
                // { "type": "hand", "targets": [ "*" ] },
                // { "type": "face", "targets": [ "*" ] },
            ];

            config.Input = { "name": "webcam_on_page" };

            console.log(config);

            // makes page title config.name
            document.getElementById("popConfigName").innerHTML = "Pop Name: " + config.name;

            let SAVE_FRAMES = false;
            let DEBUG_FRAMES = true;

            if (SAVE_FRAMES) { DEBUG_FRAMES = false; }

            if (DEBUG_FRAMES)
            {
                // load json file ./test_data/pose_capture_data.json and every 100ms push a frame to thirdEyePop
                let frames = [];
                fetch("./test_data/ball.json")
                    .then(response => response.json())
                    .then(data => frames = data)
                    .then(() =>
                    {
                        let i = 0;
                        setInterval(() =>
                        {
                            thirdEyePop.pushPredictionData(frames[ i++ % frames.length ]);
                        }, 1);

                    });

                return;
            }

            const ep = EyePopSDK.EyePopSDK.init(config);

            const SAVE_FRAMES_INTERVAL = 1000;


            EyePopSDK.EyePopAPI.instance.OnDrawFrameEnd = function (prediction)
            {
                thirdEyePop.pushPredictionData(prediction);

                if (SAVE_FRAMES)
                {

                    if (prediction)
                    {
                        cached_data.push(prediction);
                    }

                    if (cached_data.length % SAVE_FRAMES_INTERVAL == 0)
                    {
                        save();
                    }
                }
            }

            }

            EyePopSDK.EyePopAPI.FetchPopConfig(pop_endpoint, token)
                .then(response => config = response)
                .then(() => { run() });

        </script>
</body>

</html>


<!-- https://raw.githubusercontent.com/64blit/files/main/videos/store_cctv.mp4 -->
<!-- http://localhost:8081/Projectiles/2_spider_man.html -->
